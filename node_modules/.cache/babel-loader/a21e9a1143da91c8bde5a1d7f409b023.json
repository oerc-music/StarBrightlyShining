{"ast":null,"code":"import { createSession, patchAndProcessAnnotation, TRANSITION_TO_NEXT_SESSION } from './index';\nexport const MARKUP_EMPHASIS = \"meldterm:emphasis\";\nexport const MARKUP_HIGHLIGHT = \"meldterm:highlight\";\nexport const MARKUP_HIGHLIGHT2 = \"meldterm:highlight2\";\nexport const CUE_AUDIO = \"meldterm:CueAudio\";\nexport const CUE_AUDIO_HANDLED = \"CUE_AUDIO_HANDLED\";\nexport const CUE_VIDEO = \"meldterm:CueVideo\";\nexport const CUE_VIDEO_HANDLED = \"CUE_VIDEO_HANDLED\";\nexport const CUE_IMAGE = \"meldterm:CueImage\";\nexport const CUE_IMAGE_HANDLED = \"CUE_IMAGE_HANDLED\";\nexport const ANNOTATION_HANDLED = \"ANNOTATION_HANDLED\";\nexport const ANNOTATION_NOT_HANDLED = \"ANNOTATION_NOT_HANDLED\";\nexport const ANNOTATION_PATCHED = \"ANNOTATION_PATCHED\";\nexport const ANNOTATION_POSTED = \"ANNOTATION_POSTED\";\nexport const ANNOTATION_SKIPPED = \"ANNOTATION_SKIPPED\";\nexport const QUEUE_NEXT_SESSION = \"QUEUE_NEXT_SESSION\";\nexport function handleCueImage(component, annotation, uri, fragments, fragImages) {\n  const haveImages = fragments.filter(f => f in fragImages);\n\n  if (!haveImages.length) {\n    return annotationNotHandled(annotation);\n  }\n\n  haveImages.map(f => {\n    const fLocalId = f.substr(f.indexOf(\"#\"));\n    const element = component.querySelector(fLocalId);\n    const myImage = fragImages[f];\n\n    element.onclick = function () {\n      let images = document.querySelectorAll(\"img\");\n      Array.prototype.map.call(images, function (i) {\n        i.style.visibility = \"hidden\";\n      });\n      const query = \"img[src='\" + myImage + \"']\";\n      document.querySelector(query).style.visibility = \"visible\";\n    };\n  });\n  return annotationHandled(annotation);\n}\nexport function TEIScroll(element) {\n  if (element.closest('svg')) {\n    var targetClass = false;\n\n    for (var c = 0; c < element.classList.length; c++) {\n      if (element.classList[c].indexOf(\"__\") > -1) {\n        targetClass = element.classList[c];\n        var targetElements = document.getElementsByClassName(targetClass);\n\n        for (var i = 0; i < targetElements.length; i++) {\n          var textBox = targetElements[i].closest('.TEIContainer');\n\n          if (textBox) {\n            targetElements[i].scrollIntoView;\n            textBox.scrollTop = textBox.offsetTop + targetElements[i].offsetTop - textBox.clientHeight / 2;\n          }\n        }\n\n        return true;\n      }\n    }\n  }\n\n  return true;\n}\nexport function handleCueAudio(component, annotation, body, uri, fragments) {\n  if (\"MEI\" in fragments && \"Audio\" in fragments) {\n    fragments.MEI.map(f => {\n      const fLocalId = f.substr(f.indexOf(\"#\"));\n      const element = component.querySelector(fLocalId);\n\n      if (element) {\n        //TODO figure out what to do with multiple audio fragments\n        const audioUri = fragments.Audio[0].split(\"#\")[0];\n        const audioFrag = fragments.Audio[0].split(\"#\")[1];\n        const audioFragTime = parseFloat(audioFrag.substr(audioFrag.indexOf(\"t=\") + 2));\n\n        element.onclick = function () {\n          TEIScroll(element);\n          const query = \"audio[data-uri='\" + audioUri + \"']\";\n          let myPlayers = document.querySelectorAll(query);\n          Array.prototype.map.call(myPlayers, function (p) {\n            p.currentTime = audioFragTime;\n          });\n        };\n\n        applyAnnotationId(element, annotation);\n      }\n    });\n    return annotationHandled(annotation);\n  } // console.log(\"Cannot handle cue audio without MEI and audio fragments!\", fragments);\n\n\n  return annotationNotHandled(annotation);\n}\nexport function handleCueVideo(component, annotation, body, uri, fragments) {\n  if (\"MEI\" in fragments && \"Video\" in fragments) {\n    fragments.MEI.map(f => {\n      const fLocalId = f.substr(f.indexOf(\"#\"));\n      const element = component.querySelector(fLocalId);\n\n      if (element) {\n        //TODO figure out what to do with multiple audio fragments\n        const videoUri = fragments.video[0].split(\"#\")[0];\n        const videoFrag = fragments.video[0].split(\"#\")[1];\n        const videoFragTime = parseFloat(audioFrag.substr(videoFrag.indexOf(\"t=\") + 2));\n\n        element.onclick = function () {\n          TEIScroll(element);\n          const query = \"video[data-uri='\" + audioUri + \"']\";\n          let myPlayers = document.querySelectorAll(query);\n          Array.prototype.map.call(myPlayers, function (p) {\n            p.currentTime = audioFragTime;\n          });\n        };\n\n        applyAnnotationId(element, annotation);\n      }\n    });\n    return annotationHandled(annotation);\n  } // console.log(\"Cannot handle cue audio without MEI and video fragments!\", fragments);\n\n\n  return annotationNotHandled(annotation);\n}\nexport function handleEmphasis(component, annotation, uri, fragments) {\n  assignClass(\"meld-emphasis\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleHighlight(component, annotation, uri, fragments) {\n  assignClass(\"meld-highlight\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleHighlight2(component, annotation, uri, fragments) {\n  assignClass(\"meld-highlight2\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleIdentifyMuzicode(component, annotation, uri, fragments) {\n  assignClass(\"meld-muzicode-identify\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleChoiceMuzicode(component, annotation, uri, fragments) {\n  // console.log(\"CHOICE!\");\n  assignClass(\"meld-muzicode-choice\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleChallengePassed(component, annotation, uri, fragments) {\n  // console.log(\"Challenge passed!\");\n  assignClassToClosestMeasure(\"meld-muzicode-challenge-passed\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleDisklavierStart(component, annotation, uri, fragments) {\n  assignClass(\"meld-muzicode-disklavier-start\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleMuzicodeTriggered(component, annotation, uri, fragments, muzicodeTarget, session, nextSession, etag) {\n  // console.log(\"Muzicode triggered:\", component, annotation, uri, fragments, muzicodeTarget, etag);\n  return dispatch => {\n    // dispatch appropriate rendering handler depending on muzicode type\n    switch (muzicodeTarget[\"muzicodeType\"][\"@id\"]) {\n      case \"mc:Choice\":\n        dispatch(patchAndProcessAnnotation(handleChoiceMuzicode(component, annotation, uri, fragments), session, etag, annotation, createSession(session.substr(0, session.lastIndexOf(\"/\")), muzicodeTarget[\"cue\"][\"@id\"], {\n          session,\n          etag\n        })));\n        break;\n\n      case \"mc:Disklavier\":\n        dispatch(patchAndProcessAnnotation(handleDisklavierStart(component, annotation, uri, fragments), session, etag, annotation));\n        break;\n\n      case \"mc:Approaching\":\n        dispatch(patchAndProcessAnnotation(handleIdentifyMuzicode(component, annotation, uri, fragments), session, etag, annotation));\n        break;\n\n      case \"mc:Challenge\":\n        dispatch(patchAndProcessAnnotation(handleChallengePassed(component, annotation, uri, fragments), session, etag, annotation, createSession(session.substr(0, session.lastIndexOf(\"/\")), muzicodeTarget[\"cue\"][\"@id\"], {\n          session,\n          etag\n        })));\n        break;\n\n      default: // console.log(\"Muzicode of unknown type: \", muzicodeTarget);\n\n    }\n\n    return annotationHandled();\n  };\n}\nexport function handleArchivedMuzicodeTrigger(component, annotation, uri, fragments, muzicodeTarget, session, nextSession, etag) {\n  // console.log(\"Archived muzicode trigger:\", component, annotation, uri, fragments, muzicodeTarget);\n  return dispatch => {\n    // dispatch appropriate rendering handler depending on muzicode type\n    switch (muzicodeTarget[\"muzicodeType\"][\"@id\"]) {\n      case \"mc:Choice\":\n        dispatch(handleChoiceMuzicode(component, annotation, uri, fragments));\n        dispatch({\n          type: QUEUE_NEXT_SESSION,\n          payload: muzicodeTarget[\"cue\"][\"@id\"]\n        });\n        break;\n\n      case \"mc:Disklavier\":\n        dispatch(handleDisklavierStart(component, annotation, uri, fragments));\n        break;\n\n      case \"mc:Approaching\":\n        dispatch(handleIdentifyMuzicode(component, annotation, uri, fragments));\n        break;\n\n      case \"mc:Challenge\":\n        dispatch(handleChallengePassed(component, annotation, uri, fragments));\n        dispatch({\n          type: QUEUE_NEXT_SESSION,\n          payload: muzicodeTarget[\"cue\"][\"@id\"]\n        });\n        break;\n\n      default: // console.log(\"Muzicode of unknown type: \", muzicodeTarget);\n\n    }\n\n    return annotationHandled();\n  };\n}\nexport function handleQueueNextSession(session, etag, annotation) {\n  // console.log(\"Queueing next session: \", annotation);\n  return dispatch => {\n    const action = {\n      type: QUEUE_NEXT_SESSION,\n      payload: annotation[\"oa:hasBody\"][\"@id\"]\n    }; //dispatch(patchAndProcessAnnotation(action, session, etag, annotation));\n\n    dispatch(action);\n  };\n}\nexport function handleCreateNextSession(session, etag, annotation) {\n  // console.log(\"Handling createNextSession: \", session, etag, annotation);\n  return dispatch => {\n    dispatch(patchAndProcessAnnotation(createSession(session.substr(0, session.lastIndexOf(\"/\")), annotation[\"oa:hasBody\"][\"@id\"], {\n      etag: etag\n    }), session, etag, annotation));\n  };\n}\nexport function handleTransitionToNextSession(session, etag, annotation) {\n  // console.log(\"Transitioning to next session!\");\n  return {\n    type: TRANSITION_TO_NEXT_SESSION\n  };\n}\n\nfunction annotationHandled(annotation) {\n  return {\n    type: ANNOTATION_HANDLED,\n    payload: annotation\n  };\n}\n\nfunction annotationNotHandled(annotation) {\n  return {\n    type: ANNOTATION_NOT_HANDLED,\n    payload: annotation\n  };\n}\n\nfunction applyAnnotationId(element, annotation) {\n  // stamp this element with the specified annotation id\n  const id = annotation[\"@id\"].replace(\":\", \"__\");\n\n  if (!element.classList.contains(id)) {\n    element.classList.add(id);\n  }\n}\n\nfunction assignClass(className, component, annotation, uri, fragments) {\n  fragments.map(f => {\n    const fLocalId = f.substr(f.indexOf(\"#\"));\n    const element = component.querySelector(fLocalId);\n\n    if (element) {\n      if (!element.classList.contains(className)) {\n        element.classList.add(className);\n      }\n\n      applyAnnotationId(element, annotation);\n\n      element.onmouseover = function () {\n        let highlighted = document.querySelectorAll(\".\" + className);\n        Array.prototype.map.call(highlighted, function (em) {\n          em.classList.add(\"infocus\");\n        });\n      };\n\n      element.onmouseleave = function () {\n        let highlighted = document.querySelectorAll(\".\" + className);\n        Array.prototype.map.call(highlighted, function (em) {\n          em.classList.remove(\"infocus\");\n        });\n      };\n    }\n  });\n}\n\nfunction assignClassToClosestMeasure(className, component, annotation, uri, fragments) {\n  // for each fragment, assign the class label to the nearest parent that is an mei measure\n  // n.b. could be the fragment itself\n  fragments.map(f => {\n    const fLocalId = f.substr(f.indexOf(\"#\"));\n    const element = component.querySelector(fLocalId);\n    const closestMeasure = element ? element.closest(\".measure\") : null;\n\n    if (closestMeasure) {\n      if (!closestMeasure.classList.contains(className)) {\n        closestMeasure.classList.add(className);\n      }\n\n      applyAnnotationId(closestMeasure, annotation);\n\n      closestMeasure.onmouseover = function () {\n        let highlighted = document.querySelectorAll(\".\" + className);\n        Array.prototype.map.call(highlighted, function (em) {\n          em.classList.add(\"infocus\");\n        });\n      };\n\n      closestMeasure.onmouseleave = function () {\n        let highlighted = document.querySelectorAll(\".\" + className);\n        Array.prototype.map.call(highlighted, function (em) {\n          em.classList.remove(\"infocus\");\n        });\n      };\n    }\n  });\n}","map":{"version":3,"sources":["/Users/mark/localRepos/StarBrightlyShining/node_modules/meld-clients-core/lib/actions/meldActions.js"],"names":["createSession","patchAndProcessAnnotation","TRANSITION_TO_NEXT_SESSION","MARKUP_EMPHASIS","MARKUP_HIGHLIGHT","MARKUP_HIGHLIGHT2","CUE_AUDIO","CUE_AUDIO_HANDLED","CUE_VIDEO","CUE_VIDEO_HANDLED","CUE_IMAGE","CUE_IMAGE_HANDLED","ANNOTATION_HANDLED","ANNOTATION_NOT_HANDLED","ANNOTATION_PATCHED","ANNOTATION_POSTED","ANNOTATION_SKIPPED","QUEUE_NEXT_SESSION","handleCueImage","component","annotation","uri","fragments","fragImages","haveImages","filter","f","length","annotationNotHandled","map","fLocalId","substr","indexOf","element","querySelector","myImage","onclick","images","document","querySelectorAll","Array","prototype","call","i","style","visibility","query","annotationHandled","TEIScroll","closest","targetClass","c","classList","targetElements","getElementsByClassName","textBox","scrollIntoView","scrollTop","offsetTop","clientHeight","handleCueAudio","body","MEI","audioUri","Audio","split","audioFrag","audioFragTime","parseFloat","myPlayers","p","currentTime","applyAnnotationId","handleCueVideo","videoUri","video","videoFrag","videoFragTime","handleEmphasis","assignClass","handleHighlight","handleHighlight2","handleIdentifyMuzicode","handleChoiceMuzicode","handleChallengePassed","assignClassToClosestMeasure","handleDisklavierStart","handleMuzicodeTriggered","muzicodeTarget","session","nextSession","etag","dispatch","lastIndexOf","handleArchivedMuzicodeTrigger","type","payload","handleQueueNextSession","action","handleCreateNextSession","handleTransitionToNextSession","id","replace","contains","add","className","onmouseover","highlighted","em","onmouseleave","remove","closestMeasure"],"mappings":"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","sourcesContent":["import { createSession, patchAndProcessAnnotation, TRANSITION_TO_NEXT_SESSION } from './index';\nexport const MARKUP_EMPHASIS = \"meldterm:emphasis\";\nexport const MARKUP_HIGHLIGHT = \"meldterm:highlight\";\nexport const MARKUP_HIGHLIGHT2 = \"meldterm:highlight2\";\nexport const CUE_AUDIO = \"meldterm:CueAudio\";\nexport const CUE_AUDIO_HANDLED = \"CUE_AUDIO_HANDLED\";\nexport const CUE_VIDEO = \"meldterm:CueVideo\";\nexport const CUE_VIDEO_HANDLED = \"CUE_VIDEO_HANDLED\";\nexport const CUE_IMAGE = \"meldterm:CueImage\";\nexport const CUE_IMAGE_HANDLED = \"CUE_IMAGE_HANDLED\";\nexport const ANNOTATION_HANDLED = \"ANNOTATION_HANDLED\";\nexport const ANNOTATION_NOT_HANDLED = \"ANNOTATION_NOT_HANDLED\";\nexport const ANNOTATION_PATCHED = \"ANNOTATION_PATCHED\";\nexport const ANNOTATION_POSTED = \"ANNOTATION_POSTED\";\nexport const ANNOTATION_SKIPPED = \"ANNOTATION_SKIPPED\";\nexport const QUEUE_NEXT_SESSION = \"QUEUE_NEXT_SESSION\";\nexport function handleCueImage(component, annotation, uri, fragments, fragImages) {\n  const haveImages = fragments.filter(f => f in fragImages);\n\n  if (!haveImages.length) {\n    return annotationNotHandled(annotation);\n  }\n\n  haveImages.map(f => {\n    const fLocalId = f.substr(f.indexOf(\"#\"));\n    const element = component.querySelector(fLocalId);\n    const myImage = fragImages[f];\n\n    element.onclick = function () {\n      let images = document.querySelectorAll(\"img\");\n      Array.prototype.map.call(images, function (i) {\n        i.style.visibility = \"hidden\";\n      });\n      const query = \"img[src='\" + myImage + \"']\";\n      document.querySelector(query).style.visibility = \"visible\";\n    };\n  });\n  return annotationHandled(annotation);\n}\nexport function TEIScroll(element) {\n  if (element.closest('svg')) {\n    var targetClass = false;\n\n    for (var c = 0; c < element.classList.length; c++) {\n      if (element.classList[c].indexOf(\"__\") > -1) {\n        targetClass = element.classList[c];\n        var targetElements = document.getElementsByClassName(targetClass);\n\n        for (var i = 0; i < targetElements.length; i++) {\n          var textBox = targetElements[i].closest('.TEIContainer');\n\n          if (textBox) {\n            targetElements[i].scrollIntoView;\n            textBox.scrollTop = textBox.offsetTop + targetElements[i].offsetTop - textBox.clientHeight / 2;\n          }\n        }\n\n        return true;\n      }\n    }\n  }\n\n  return true;\n}\nexport function handleCueAudio(component, annotation, body, uri, fragments) {\n  if (\"MEI\" in fragments && \"Audio\" in fragments) {\n    fragments.MEI.map(f => {\n      const fLocalId = f.substr(f.indexOf(\"#\"));\n      const element = component.querySelector(fLocalId);\n\n      if (element) {\n        //TODO figure out what to do with multiple audio fragments\n        const audioUri = fragments.Audio[0].split(\"#\")[0];\n        const audioFrag = fragments.Audio[0].split(\"#\")[1];\n        const audioFragTime = parseFloat(audioFrag.substr(audioFrag.indexOf(\"t=\") + 2));\n\n        element.onclick = function () {\n          TEIScroll(element);\n          const query = \"audio[data-uri='\" + audioUri + \"']\";\n          let myPlayers = document.querySelectorAll(query);\n          Array.prototype.map.call(myPlayers, function (p) {\n            p.currentTime = audioFragTime;\n          });\n        };\n\n        applyAnnotationId(element, annotation);\n      }\n    });\n    return annotationHandled(annotation);\n  } // console.log(\"Cannot handle cue audio without MEI and audio fragments!\", fragments);\n\n\n  return annotationNotHandled(annotation);\n}\nexport function handleCueVideo(component, annotation, body, uri, fragments) {\n  if (\"MEI\" in fragments && \"Video\" in fragments) {\n    fragments.MEI.map(f => {\n      const fLocalId = f.substr(f.indexOf(\"#\"));\n      const element = component.querySelector(fLocalId);\n\n      if (element) {\n        //TODO figure out what to do with multiple audio fragments\n        const videoUri = fragments.video[0].split(\"#\")[0];\n        const videoFrag = fragments.video[0].split(\"#\")[1];\n        const videoFragTime = parseFloat(audioFrag.substr(videoFrag.indexOf(\"t=\") + 2));\n\n        element.onclick = function () {\n          TEIScroll(element);\n          const query = \"video[data-uri='\" + audioUri + \"']\";\n          let myPlayers = document.querySelectorAll(query);\n          Array.prototype.map.call(myPlayers, function (p) {\n            p.currentTime = audioFragTime;\n          });\n        };\n\n        applyAnnotationId(element, annotation);\n      }\n    });\n    return annotationHandled(annotation);\n  } // console.log(\"Cannot handle cue audio without MEI and video fragments!\", fragments);\n\n\n  return annotationNotHandled(annotation);\n}\nexport function handleEmphasis(component, annotation, uri, fragments) {\n  assignClass(\"meld-emphasis\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleHighlight(component, annotation, uri, fragments) {\n  assignClass(\"meld-highlight\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleHighlight2(component, annotation, uri, fragments) {\n  assignClass(\"meld-highlight2\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleIdentifyMuzicode(component, annotation, uri, fragments) {\n  assignClass(\"meld-muzicode-identify\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleChoiceMuzicode(component, annotation, uri, fragments) {\n  // console.log(\"CHOICE!\");\n  assignClass(\"meld-muzicode-choice\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleChallengePassed(component, annotation, uri, fragments) {\n  // console.log(\"Challenge passed!\");\n  assignClassToClosestMeasure(\"meld-muzicode-challenge-passed\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleDisklavierStart(component, annotation, uri, fragments) {\n  assignClass(\"meld-muzicode-disklavier-start\", component, annotation, uri, fragments);\n  return annotationHandled();\n}\nexport function handleMuzicodeTriggered(component, annotation, uri, fragments, muzicodeTarget, session, nextSession, etag) {\n  // console.log(\"Muzicode triggered:\", component, annotation, uri, fragments, muzicodeTarget, etag);\n  return dispatch => {\n    // dispatch appropriate rendering handler depending on muzicode type\n    switch (muzicodeTarget[\"muzicodeType\"][\"@id\"]) {\n      case \"mc:Choice\":\n        dispatch(patchAndProcessAnnotation(handleChoiceMuzicode(component, annotation, uri, fragments), session, etag, annotation, createSession(session.substr(0, session.lastIndexOf(\"/\")), muzicodeTarget[\"cue\"][\"@id\"], {\n          session,\n          etag\n        })));\n        break;\n\n      case \"mc:Disklavier\":\n        dispatch(patchAndProcessAnnotation(handleDisklavierStart(component, annotation, uri, fragments), session, etag, annotation));\n        break;\n\n      case \"mc:Approaching\":\n        dispatch(patchAndProcessAnnotation(handleIdentifyMuzicode(component, annotation, uri, fragments), session, etag, annotation));\n        break;\n\n      case \"mc:Challenge\":\n        dispatch(patchAndProcessAnnotation(handleChallengePassed(component, annotation, uri, fragments), session, etag, annotation, createSession(session.substr(0, session.lastIndexOf(\"/\")), muzicodeTarget[\"cue\"][\"@id\"], {\n          session,\n          etag\n        })));\n        break;\n\n      default: // console.log(\"Muzicode of unknown type: \", muzicodeTarget);\n\n    }\n\n    return annotationHandled();\n  };\n}\nexport function handleArchivedMuzicodeTrigger(component, annotation, uri, fragments, muzicodeTarget, session, nextSession, etag) {\n  // console.log(\"Archived muzicode trigger:\", component, annotation, uri, fragments, muzicodeTarget);\n  return dispatch => {\n    // dispatch appropriate rendering handler depending on muzicode type\n    switch (muzicodeTarget[\"muzicodeType\"][\"@id\"]) {\n      case \"mc:Choice\":\n        dispatch(handleChoiceMuzicode(component, annotation, uri, fragments));\n        dispatch({\n          type: QUEUE_NEXT_SESSION,\n          payload: muzicodeTarget[\"cue\"][\"@id\"]\n        });\n        break;\n\n      case \"mc:Disklavier\":\n        dispatch(handleDisklavierStart(component, annotation, uri, fragments));\n        break;\n\n      case \"mc:Approaching\":\n        dispatch(handleIdentifyMuzicode(component, annotation, uri, fragments));\n        break;\n\n      case \"mc:Challenge\":\n        dispatch(handleChallengePassed(component, annotation, uri, fragments));\n        dispatch({\n          type: QUEUE_NEXT_SESSION,\n          payload: muzicodeTarget[\"cue\"][\"@id\"]\n        });\n        break;\n\n      default: // console.log(\"Muzicode of unknown type: \", muzicodeTarget);\n\n    }\n\n    return annotationHandled();\n  };\n}\nexport function handleQueueNextSession(session, etag, annotation) {\n  // console.log(\"Queueing next session: \", annotation);\n  return dispatch => {\n    const action = {\n      type: QUEUE_NEXT_SESSION,\n      payload: annotation[\"oa:hasBody\"][\"@id\"]\n    }; //dispatch(patchAndProcessAnnotation(action, session, etag, annotation));\n\n    dispatch(action);\n  };\n}\nexport function handleCreateNextSession(session, etag, annotation) {\n  // console.log(\"Handling createNextSession: \", session, etag, annotation);\n  return dispatch => {\n    dispatch(patchAndProcessAnnotation(createSession(session.substr(0, session.lastIndexOf(\"/\")), annotation[\"oa:hasBody\"][\"@id\"], {\n      etag: etag\n    }), session, etag, annotation));\n  };\n}\nexport function handleTransitionToNextSession(session, etag, annotation) {\n  // console.log(\"Transitioning to next session!\");\n  return {\n    type: TRANSITION_TO_NEXT_SESSION\n  };\n}\n\nfunction annotationHandled(annotation) {\n  return {\n    type: ANNOTATION_HANDLED,\n    payload: annotation\n  };\n}\n\nfunction annotationNotHandled(annotation) {\n  return {\n    type: ANNOTATION_NOT_HANDLED,\n    payload: annotation\n  };\n}\n\nfunction applyAnnotationId(element, annotation) {\n  // stamp this element with the specified annotation id\n  const id = annotation[\"@id\"].replace(\":\", \"__\");\n\n  if (!element.classList.contains(id)) {\n    element.classList.add(id);\n  }\n}\n\nfunction assignClass(className, component, annotation, uri, fragments) {\n  fragments.map(f => {\n    const fLocalId = f.substr(f.indexOf(\"#\"));\n    const element = component.querySelector(fLocalId);\n\n    if (element) {\n      if (!element.classList.contains(className)) {\n        element.classList.add(className);\n      }\n\n      applyAnnotationId(element, annotation);\n\n      element.onmouseover = function () {\n        let highlighted = document.querySelectorAll(\".\" + className);\n        Array.prototype.map.call(highlighted, function (em) {\n          em.classList.add(\"infocus\");\n        });\n      };\n\n      element.onmouseleave = function () {\n        let highlighted = document.querySelectorAll(\".\" + className);\n        Array.prototype.map.call(highlighted, function (em) {\n          em.classList.remove(\"infocus\");\n        });\n      };\n    }\n  });\n}\n\nfunction assignClassToClosestMeasure(className, component, annotation, uri, fragments) {\n  // for each fragment, assign the class label to the nearest parent that is an mei measure\n  // n.b. could be the fragment itself\n  fragments.map(f => {\n    const fLocalId = f.substr(f.indexOf(\"#\"));\n    const element = component.querySelector(fLocalId);\n    const closestMeasure = element ? element.closest(\".measure\") : null;\n\n    if (closestMeasure) {\n      if (!closestMeasure.classList.contains(className)) {\n        closestMeasure.classList.add(className);\n      }\n\n      applyAnnotationId(closestMeasure, annotation);\n\n      closestMeasure.onmouseover = function () {\n        let highlighted = document.querySelectorAll(\".\" + className);\n        Array.prototype.map.call(highlighted, function (em) {\n          em.classList.add(\"infocus\");\n        });\n      };\n\n      closestMeasure.onmouseleave = function () {\n        let highlighted = document.querySelectorAll(\".\" + className);\n        Array.prototype.map.call(highlighted, function (em) {\n          em.classList.remove(\"infocus\");\n        });\n      };\n    }\n  });\n}"]},"metadata":{},"sourceType":"module"}